<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Today‚Äôs Valid Bookings</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0c10;--panel:#111217;--text:#e9eef2;--muted:#9aa4ad;--accent:#5dd3ff;--ok:#27c07d;
      --bad:#ff6b6b;--chip:#20232b;--border:#2a2f3a;--card:#151821;--shadow:0 10px 30px rgba(0,0,0,.35);
      --warn:#f5a524
    }
    @media(prefers-color-scheme:light){:root{
      --bg:#f6f7fb;--panel:#fff;--text:#1a1f2b;--muted:#5b6572;--accent:#006af6;--ok:#0b8e5a;--bad:#cc2e2e;
      --chip:#eef2f8;--border:#e6e9f0;--card:#fff;--shadow:0 8px 24px rgba(16,24,40,.08);--warn:#b8860b
    }}
    *{box-sizing:border-box}
    body{margin:0;font:14px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(180deg,var(--bg),var(--panel));color:var(--text);min-height:100vh}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px}
    .statusbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent) 30%, transparent)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--text);border:1px solid var(--border);font-size:12px;white-space:nowrap}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 18px}
    .input,select{background:var(--card);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;min-width:190px}
    .cards{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:10px}
    @media(min-width:720px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px}
    .toprow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap}
    .area{color:var(--muted)}
    .rego{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:var(--chip);border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .name{font-weight:600}
    .unit{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .footer{margin-top:18px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip)}
    .empty{text-align:center;padding:40px;border:1px dashed var(--border);border-radius:16px;background:color-mix(in srgb,var(--card) 80%, transparent)}
    .toast{position:fixed;inset:auto 16px 16px auto;background:var(--card);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow);padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(6px);transition:.25s ease}
    .toast.show{opacity:1;transform:translateY(0)}
    .hint{color:var(--warn);font-size:12px}
    .editrow{display:flex;gap:8px;align-items:center;margin-top:6px}
    /* Simple lock screen */
    #lock{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--bg),var(--panel));z-index:50}
    #lock .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:var(--shadow);min-width:320px;text-align:center}
  </style>
</head>
<body>
  <!-- BASIC PASSWORD GATE (demo) -->
  <div id="lock">
    <div class="panel">
      <h2 style="margin:0 0 12px 0;">Enter password</h2>
      <input id="pass" class="input" type="password" placeholder="Password" />
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
        <button id="unlockBtn" class="btn">Unlock</button>
      </div>
      <p id="lockMsg" class="hint" style="margin-top:10px;display:none;color:#ff8080">Wrong password</p>
      <p class="hint" style="margin-top:6px">Demo-only lock (password is <strong>password</strong>). Not real security.</p>
    </div>
  </div>

  <div class="wrap" id="app" hidden>
    <header>
      <div>
        <h1>Today‚Äôs Valid Bookings</h1>
        <div class="subtitle" id="sub"><span id="today">‚Äî</span></div>
      </div>
      <div class="statusbar">
        <span class="badge" title="Auto-refresh"><span class="dot" id="liveDot"></span> Live</span>
        <button class="btn" id="btnRefresh" title="Force refresh">Refresh</button>
        <button class="btn" id="btnExport" title="Download current JSON">Export JSON</button>
      </div>
    </header>

    <div class="controls">
      <input class="input" id="q" type="search" placeholder="Search name / unit / area / email" />
      <select id="areaFilter"><option value="">All areas</option></select>
      <span class="badge" id="count">0 bookings</span>
    </div>

    <section class="cards" id="cards"></section>
    <div class="empty" id="empty" hidden>No valid bookings for today.</div>

    <div class="footer">
      <div>Last updated: <span id="updated">‚Äî</span></div>
      <div><span class="pill" id="source">data: bookings-today.json</span></div>
    </div>
  </div>

  <div class="toast" id="toast">Data updated</div>

  <script>
    // ====== DEMO PASSWORD (plain-text on purpose for your test) ======
    const DEMO_PASSWORD = "password";

    // ====== CONFIG ======
    const REFRESH_EVERY_MS = 60_000;
    const DATA_URL = new URLSearchParams(location.search).get("data") || "bookings-today.json";
    const POST_URL = new URLSearchParams(location.search).get("post"); // optional webhook for rego edits

    // ====== STATE ======
    let prevHash = null;
    let all = { date: null, timezone: "Australia/Melbourne", generated_at: null, bookings: [] };

    // ====== UTIL ======
    const fmtDateLong = (s)=>{ try{ const d=s?new Date(s):new Date(); return new Intl.DateTimeFormat("en-AU",{dateStyle:"full"}).format(d);}catch{return s||"‚Äî"} };
    const escapeHtml = (x)=> String(x||"").replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
    const sha256 = async (str)=>{ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest("SHA-256",enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("") };
    const hoursUntil = (yyyy_mm_dd)=>{
      if(!yyyy_mm_dd) return null;
      const [y,m,d]=yyyy_mm_dd.split("-").map(Number);
      const expiry=new Date(y,m-1,d,23,59,59).getTime();
      const diff=Math.max(0,Math.floor((expiry-Date.now())/(1000*60*60)));
      return diff;
    };

    // ====== REGO OVERRIDES (local, optional POST) ======
    const LS_KEY = "regoOverrides_v1";
    const getOverrides = ()=>{ try{return JSON.parse(localStorage.getItem(LS_KEY)||"{}")}catch{return{}} };
    const getOverride = (k)=> getOverrides()[k];
    const setOverride = async (key, rego, booking)=>{
      const map=getOverrides();
      if(rego) map[key]=rego; else delete map[key];
      localStorage.setItem(LS_KEY, JSON.stringify(map));
      if(POST_URL){
        try{ await fetch(POST_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key,rego,booking,at:new Date().toISOString()})}); }catch{}
      }
    };
    const makeKey = (b)=> b.id || b.booking_number || `${b.name}|${b.unit}|${b.start_date}|${b.end_date}`;

    // ====== RENDER ======
    function render(list){
      const q = document.getElementById("q").value.trim().toLowerCase();
      const areaSel = document.getElementById("areaFilter").value;
      let filtered = list;
      if(q) filtered = filtered.filter(b => [b.name,b.unit,b.area,b.email].join(" ").toLowerCase().includes(q));
      if(areaSel) filtered = filtered.filter(b => (b.area||"").toLowerCase() === areaSel.toLowerCase());
      filtered.sort((a,b)=> (a.end_date||"").localeCompare(b.end_date||"") || (a.area||"").localeCompare(b.area||""));

      const cards = document.getElementById("cards");
      cards.innerHTML = "";
      document.getElementById("empty").hidden = !!filtered.length;

      for(const b of filtered){
        const key = makeKey(b);
        const rego = (getOverride(key) || b.vehicle_rego || "").toUpperCase();
        const hours = b.end_date ? hoursUntil(b.end_date) : null;
        const validLine = b.end_date ? `Valid until 11:59pm ${escapeHtml(b.end_date)}${hours!==null?` ‚Ä¢ ~${hours}h left`:""}` : "Valid booking";

        const el = document.createElement("article");
        el.className = "card";
        el.innerHTML = `
          <div class="toprow">
            <span class="badge">üÖøÔ∏è ${escapeHtml(b.area || "Parking")}</span>
            <span class="badge">${escapeHtml(validLine)}</span>
            <div class="right">
              ${b.booking_number ? `<span class="badge" title="Booking #">#${escapeHtml(b.booking_number)}</span>` : ""}
              ${b.source_link ? `<a class="badge" href="${escapeHtml(b.source_link)}" target="_blank" rel="noopener">Slack</a>` : ""}
            </div>
          </div>
          <div class="row">
            <div class="name">${escapeHtml(b.name || "‚Äî")}</div>
            <div class="unit">${escapeHtml(b.unit || "")}</div>
          </div>
          ${regoSection(key, rego, b)}
          <div class="hint">${rego ? "" : "No rego on file ‚Äî add one if known (optional)."}</div>
        `;
        cards.appendChild(el);

        const saveBtn = el.querySelector(".btn-save");
        const cancelBtn = el.querySelector(".btn-cancel");
        const input = el.querySelector(".input-rego");
        if(saveBtn && input){
          saveBtn.addEventListener("click", async ()=>{
            const val=(input.value||"").trim().toUpperCase();
            await setOverride(key,val,b);
            showToast(val?`Saved rego: ${val}`:"Cleared rego");
            render(list);
          });
        }
        if(cancelBtn && input){
          cancelBtn.addEventListener("click", ()=>{ input.value = getOverride(key) || b.vehicle_rego || ""; });
        }
      }
      document.getElementById("count").textContent = `${filtered.length} booking${filtered.length===1?"":"s"}`;
    }

    function regoSection(key, rego, b){
      return `
        <div class="editrow">
          <label for="rego-${encodeURIComponent(key)}" class="rego" title="Vehicle rego">${rego?escapeHtml(rego):"‚Äî"}</label>
          <input id="rego-${encodeURIComponent(key)}" class="input input-rego" value="${escapeHtml(rego)}" placeholder="Enter rego (optional)" maxlength="12" />
          <button class="btn btn-save">Save</button>
          <button class="btn btn-cancel" title="Reset field">Reset</button>
        </div>
      `;
    }

    function buildAreas(list){
      const sel=document.getElementById("areaFilter");
      const areas=Array.from(new Set(list.map(b=>b.area).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      sel.innerHTML = '<option value="">All areas</option>' + areas.map(a=>`<option>${escapeHtml(a)}</option>`).join("");
    }

    // ====== FETCH ======
    async function load(){
      const src = DATA_URL + (DATA_URL.includes("?") ? `&_=${Date.now()}` : `?t=${Date.now()}`);
      document.getElementById("source").textContent = `data: ${DATA_URL}`;
      try{
        const res = await fetch(src,{cache:"no-store"});
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        const json = await res.json();
        const {date,timezone,generated_at,bookings} = json || {};
        all = {date, timezone: timezone || "Australia/Melbourne", generated_at, bookings: Array.isArray(bookings)?bookings:[]};
        const hash = await sha256(JSON.stringify(all));
        if(prevHash && hash!==prevHash) showToast();
        prevHash = hash;
        document.getElementById("today").textContent = fmtDateLong(date || generated_at);
        buildAreas(all.bookings);
        render(all.bookings);
        localStorage.setItem("bookings-cache", JSON.stringify(all));
        document.getElementById("updated").textContent = fmtDateLong(generated_at || new Date().toISOString());
      }catch(e){
        const cached = localStorage.getItem("bookings-cache");
        if(cached){ try{ all = JSON.parse(cached); render(all.bookings);}catch{} }
        showToast("Offline: showing cached data");
      }
    }

    // ====== EXPORT ======
    function exportJson(){
      const map=getOverrides();
      const merged = all.bookings.map(b=>{ const k=makeKey(b); const r=map[k]; return r?{...b,vehicle_rego:r}:b; });
      const out = {...all, bookings: merged, exported_at:new Date().toISOString()};
      const blob = new Blob([JSON.stringify(out,null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bookings-today.json"; a.click(); URL.revokeObjectURL(a.href);
    }

    // ====== APP WIRING ======
    function startApp(){
      document.getElementById("btnRefresh").addEventListener("click", load);
      document.getElementById("btnExport").addEventListener("click", exportJson);
      document.getElementById("q").addEventListener("input", ()=>render(all.bookings));
      document.getElementById("areaFilter").addEventListener("change", ()=>render(all.bookings));
      let on=true; setInterval(()=>{ document.getElementById("liveDot").style.opacity=on?1:.35; on=!on; },800);
      load(); setInterval(load, REFRESH_EVERY_MS);
    }

    // ====== LOCK BEHAVIOUR ======
    document.getElementById("unlockBtn").addEventListener("click", ()=>{
      const val = document.getElementById("pass").value;
      if(val === DEMO_PASSWORD){
        document.getElementById("lock").style.display="none";
        document.getElementById("app").hidden=false;
        startApp();
      }else{
        document.getElementById("lockMsg").style.display="block";
      }
    });

    // Show lock on load
    document.getElementById("app").hidden = true;
    document.getElementById("lock").style.display = "flex";

    function showToast(msg){ const t=document.getElementById("toast"); t.textContent=msg||"Data updated"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2500); }
  </script>
</body>
</html>
